import{_ as W,c as n,o as d,a as e,d as k,t as r,F as I,p as x,m as X,n as Y,e as f,A as N,E as Z,w as D,v as C,B as $,x as ee,r as u,k as te,G as oe,l as m}from"./index-BV4rXfZR.js";const se={name:"CloudImages",setup(){const i=ee(),t=u([]),T=u([]),s=u(!1),F=u(!1),S=u(!1),o=u(null),p=u(!1),b=u(!1),M=u({}),A=u(!1),U=u(!1);let v=null;const w=u({name:"",filename:"",download_url:"",os_type:"",version:"",architecture:"amd64",checksum:""}),h=u({selectedNodeId:"",selectedImageIds:[]}),y=async()=>{s.value=!0;try{const l=await m.cloudImages.list();t.value=l.data}catch(l){console.error("Failed to fetch cloud images:",l)}finally{s.value=!1}},B=async l=>{try{await m.cloudImages.download(l),i.success("Cloud image download started"),V()}catch(a){console.error("Failed to start download:",a),i.error("Failed to start download")}},O=async()=>{p.value=!0;try{o.value?(await m.cloudImages.update(o.value.id,w.value),i.success("Cloud image updated successfully")):(await m.cloudImages.create(w.value),i.success("Cloud image added successfully")),L(),y()}catch(l){console.error("Failed to save cloud image:",l),i.error("Failed to save cloud image")}finally{p.value=!1}},E=l=>{o.value=l,w.value={name:l.name,filename:l.filename,download_url:l.download_url,os_type:l.os_type,version:l.version||"",architecture:l.architecture,checksum:l.checksum||""},F.value=!0},R=async l=>{if(confirm("Are you sure you want to delete this cloud image?"))try{await m.cloudImages.delete(l),i.success("Cloud image deleted successfully"),y()}catch(a){console.error("Failed to delete cloud image:",a),i.error("Failed to delete cloud image")}},L=()=>{F.value=!1,o.value=null,w.value={name:"",filename:"",download_url:"",os_type:"",version:"",architecture:"amd64",checksum:""}},z=l=>{if(!l)return"0 B";const a=["B","KB","MB","GB","TB"],g=Math.floor(Math.log(l)/Math.log(1024));return Math.round(l/Math.pow(1024,g)*100)/100+" "+a[g]},P=l=>({ubuntu:"Ubuntu",debian:"Debian",centos:"CentOS",rocky:"Rocky Linux",alma:"AlmaLinux",fedora:"Fedora",opensuse:"openSUSE",other:"Other"})[l]||l,q=async()=>{try{const l=await m.proxmox.listHosts(),a=[];for(const g of l.data)try{const c=await m.proxmox.listNodes(g.id);c.data&&c.data.length>0&&c.data.forEach(_=>{a.push({id:_.id,node_name:_.node_name,proxmox_host_name:g.name})})}catch(c){console.error(`Failed to fetch nodes for host ${g.name}:`,c)}T.value=a}catch(l){console.error("Failed to fetch nodes:",l),i.error("Failed to fetch Proxmox nodes")}},H=async()=>{if(!h.value.selectedNodeId||h.value.selectedImageIds.length===0){i.error("Please select a node and at least one cloud image");return}b.value=!0;try{await m.cloudImages.setupTemplates({node_id:parseInt(h.value.selectedNodeId),cloud_image_ids:h.value.selectedImageIds}),i.success("Template setup started! This may take several minutes."),S.value=!1,h.value={selectedNodeId:"",selectedImageIds:[]}}catch(l){console.error("Failed to setup templates:",l),i.error("Failed to start template setup")}finally{b.value=!1}},j=async()=>{S.value=!0,await q()},V=()=>{v||(v=setInterval(()=>{y(),!t.value.some(a=>a.download_status==="downloading")&&v&&(clearInterval(v),v=null)},2e3))},G=async()=>{A.value=!0,M.value={};try{const l=await m.proxmox.listHosts(),a={};for(const g of l.data)try{const c=await m.proxmox.listNodes(g.id);if(c.data&&c.data.length>0)for(const _ of c.data){const Q=await m.cloudImages.checkTemplates(_.id);a[_.id]=Q.data}}catch(c){console.error(`Failed to check templates for host ${g.name}:`,c)}M.value=a,i.success("Template status checked successfully")}catch(l){console.error("Failed to check templates:",l),i.error("Failed to check template status")}finally{A.value=!1}},K=l=>Object.values(l).filter(a=>a).length,J=async()=>{var l;U.value=!0;try{const a=await m.cloudImages.fetchLatest();a.data.updated_count>0?(((l=a.data.updated_images)==null?void 0:l.some(c=>c.status==="added"))?i.success(`Added ${a.data.updated_count} cloud image(s) to database`):i.success(`Updated ${a.data.updated_count} cloud image(s)`),await y()):i.info("All cloud images are up to date"),a.data.errors&&a.data.errors.length>0&&(console.error("Cloud image errors:",a.data.errors),i.warning(`Some images could not be updated: ${a.data.errors.length} errors`))}catch(a){console.error("Failed to fetch latest cloud images:",a),i.error("Failed to fetch latest cloud images")}finally{U.value=!1}};return te(()=>{y(),t.value.some(a=>a.download_status==="downloading")&&V()}),oe(()=>{v&&clearInterval(v)}),{images:t,nodes:T,loading:s,showAddModal:F,showSetupModal:S,editingImage:o,imageForm:w,setupForm:h,saving:p,settingUpTemplates:b,templateStatus:M,checkingTemplates:A,fetchingLatest:U,fetchImages:y,downloadImage:B,saveImage:O,editImage:E,deleteImage:R,closeModal:L,setupTemplates:H,openSetupModal:j,checkAllTemplates:G,getTemplateCount:K,fetchLatestImages:J,formatBytes:z,formatOSType:P}}},le={class:"cloud-images-page"},ae={class:"card"},ne={class:"card-header"},de={class:"flex gap-1"},re=["disabled"],ie=["disabled"],ce={key:0,class:"template-status-section"},ue={class:"template-status-grid"},me={class:"node-status-header"},pe={class:"node-name"},ge={class:"template-count"},fe={class:"template-list"},ve={class:"template-vmid"},be={key:1,class:"loading-spinner"},he={key:2,class:"text-center text-muted"},ye={key:3,class:"table-container"},ke={class:"table"},we={class:"badge badge-info"},_e={key:0,class:"download-progress"},Ie={class:"progress-bar-container"},xe={class:"text-xs text-muted"},Ce={key:1,class:"badge badge-success"},Fe={key:2,class:"badge badge-danger"},Se={key:3,class:"badge badge-secondary"},Te={class:"flex gap-1"},Me=["onClick"],Ae={key:1,class:"btn btn-secondary btn-sm",disabled:""},Ue=["onClick"],Ne=["onClick"],De={class:"modal-header"},Le={class:"modal-body"},Ve={class:"form-group"},Be=["value"],Oe={class:"form-group"},Ee={class:"checkbox-list"},Re=["value"],ze={key:0,class:"alert alert-info"},Pe={class:"modal-footer"},qe=["disabled"],He=["disabled"],je={class:"modal-header"},Ge={class:"form-group"},Ke={class:"form-group"},Je={class:"form-group"},Qe={class:"grid grid-cols-2 gap-2"},We={class:"form-group"},Xe={class:"form-group"},Ye={class:"grid grid-cols-2 gap-2"},Ze={class:"form-group"},$e={class:"form-group"},et={class:"modal-footer"},tt=["disabled"];function ot(i,t,T,s,F,S){return d(),n("div",le,[e("div",ae,[e("div",ne,[t[23]||(t[23]=e("h3",null,"Cloud Images",-1)),e("div",de,[e("button",{onClick:t[0]||(t[0]=(...o)=>s.fetchLatestImages&&s.fetchLatestImages(...o)),class:"btn btn-outline",disabled:s.fetchingLatest},r(s.fetchingLatest?"ðŸ”„ Updating...":"â¬‡ï¸ Fetch Latest"),9,re),e("button",{onClick:t[1]||(t[1]=(...o)=>s.checkAllTemplates&&s.checkAllTemplates(...o)),class:"btn btn-outline",disabled:s.checkingTemplates},r(s.checkingTemplates?"ðŸ”„ Checking...":"ðŸ” Check Templates"),9,ie),e("button",{onClick:t[2]||(t[2]=(...o)=>s.openSetupModal&&s.openSetupModal(...o)),class:"btn btn-outline"},"âš™ï¸ Setup Templates"),e("button",{onClick:t[3]||(t[3]=o=>s.showAddModal=!0),class:"btn btn-primary"},"+ Add Cloud Image")])]),s.templateStatus&&Object.keys(s.templateStatus).length>0?(d(),n("div",ce,[t[24]||(t[24]=e("h4",{class:"template-status-title"},"Template Status by Node",-1)),e("div",ue,[(d(!0),n(I,null,x(s.templateStatus,o=>(d(),n("div",{key:o.node_id,class:"node-status-card"},[e("div",me,[e("span",pe,r(o.node_name),1),e("span",ge,r(s.getTemplateCount(o.templates))+" templates",1)]),e("div",fe,[(d(!0),n(I,null,x(o.templates,(p,b)=>(d(),n("div",{key:b,class:"template-item"},[e("span",ve,r(b),1),e("span",{class:X(["template-badge",p?"exists":"missing"])},r(p?"âœ“ Exists":"âœ— Missing"),3)]))),128))])]))),128))])])):k("",!0),s.loading?(d(),n("div",be)):s.images.length===0?(d(),n("div",he,[...t[25]||(t[25]=[e("p",null,"No cloud images configured yet.",-1),e("p",{class:"text-sm"},"Add cloud images for fast VM deployment.",-1)])])):(d(),n("div",ye,[e("table",ke,[t[26]||(t[26]=e("thead",null,[e("tr",null,[e("th",null,"Name"),e("th",null,"OS Type"),e("th",null,"Version"),e("th",null,"Architecture"),e("th",null,"Size"),e("th",null,"Download Status"),e("th",null,"Actions")])],-1)),e("tbody",null,[(d(!0),n(I,null,x(s.images,o=>(d(),n("tr",{key:o.id},[e("td",null,r(o.name),1),e("td",null,[e("span",we,r(s.formatOSType(o.os_type)),1)]),e("td",null,r(o.version||"N/A"),1),e("td",null,r(o.architecture),1),e("td",null,r(o.file_size?s.formatBytes(o.file_size):"Unknown"),1),e("td",null,[o.download_status==="downloading"?(d(),n("div",_e,[e("div",Ie,[e("div",{class:"progress-bar-fill",style:Y({width:o.download_progress+"%"})},null,4)]),e("span",xe,r(o.download_progress)+"%",1)])):o.is_downloaded?(d(),n("span",Ce,"Downloaded")):o.download_status==="error"?(d(),n("span",Fe,"Error")):(d(),n("span",Se,"Not Downloaded"))]),e("td",null,[e("div",Te,[!o.is_downloaded&&o.download_status!=="downloading"?(d(),n("button",{key:0,onClick:p=>s.downloadImage(o.id),class:"btn btn-primary btn-sm"}," Download ",8,Me)):k("",!0),o.download_status==="downloading"?(d(),n("button",Ae," Downloading... ")):k("",!0),e("button",{onClick:p=>s.editImage(o),class:"btn btn-outline btn-sm"},"Edit",8,Ue),e("button",{onClick:p=>s.deleteImage(o.id),class:"btn btn-danger btn-sm"},"Delete",8,Ne)])])]))),128))])])]))]),s.showSetupModal?(d(),n("div",{key:0,class:"modal",onClick:t[10]||(t[10]=o=>s.showSetupModal=!1)},[e("div",{class:"modal-content",onClick:t[9]||(t[9]=D(()=>{},["stop"]))},[e("div",De,[t[27]||(t[27]=e("h3",null,"Setup Cloud Image Templates",-1)),e("button",{onClick:t[4]||(t[4]=o=>s.showSetupModal=!1),class:"btn-close"},"Ã—")]),e("div",Le,[t[33]||(t[33]=e("p",{class:"text-muted mb-2"},"Automatically create cloud image templates on a Proxmox node.",-1)),e("div",Ve,[t[29]||(t[29]=e("label",{class:"form-label"},"Select Proxmox Node *",-1)),f(e("select",{"onUpdate:modelValue":t[5]||(t[5]=o=>s.setupForm.selectedNodeId=o),class:"form-control",required:""},[t[28]||(t[28]=e("option",{value:""},"Choose a node...",-1)),(d(!0),n(I,null,x(s.nodes,o=>(d(),n("option",{key:o.id,value:o.id},r(o.node_name)+" ("+r(o.proxmox_host_name)+") ",9,Be))),128))],512),[[N,s.setupForm.selectedNodeId]])]),e("div",Oe,[t[30]||(t[30]=e("label",{class:"form-label"},"Select Cloud Images to Setup *",-1)),e("div",Ee,[(d(!0),n(I,null,x(s.images,o=>(d(),n("label",{key:o.id,class:"checkbox-item"},[f(e("input",{type:"checkbox",value:o.id,"onUpdate:modelValue":t[6]||(t[6]=p=>s.setupForm.selectedImageIds=p)},null,8,Re),[[Z,s.setupForm.selectedImageIds]]),e("span",null,r(o.name)+" ("+r(o.os_type)+" "+r(o.version)+")",1)]))),128))]),t[31]||(t[31]=e("p",{class:"text-xs text-muted mt-1"},"Selected images will be created as templates 9000+",-1))]),s.settingUpTemplates?(d(),n("div",ze,[...t[32]||(t[32]=[e("p",null,"Setting up templates... This may take several minutes.",-1),e("p",{class:"text-sm"},"Templates are being downloaded and configured in the background.",-1)])])):k("",!0)]),e("div",Pe,[e("button",{onClick:t[7]||(t[7]=o=>s.showSetupModal=!1),class:"btn btn-outline",disabled:s.settingUpTemplates}," Cancel ",8,qe),e("button",{onClick:t[8]||(t[8]=(...o)=>s.setupTemplates&&s.setupTemplates(...o)),class:"btn btn-primary",disabled:!s.setupForm.selectedNodeId||s.setupForm.selectedImageIds.length===0||s.settingUpTemplates},r(s.settingUpTemplates?"Setting Up...":"Setup Templates"),9,He)])])])):k("",!0),s.showAddModal?(d(),n("div",{key:1,class:"modal",onClick:t[22]||(t[22]=o=>s.showAddModal=!1)},[e("div",{class:"modal-content",onClick:t[21]||(t[21]=D(()=>{},["stop"]))},[e("div",je,[e("h3",null,r(s.editingImage?"Edit":"Add")+" Cloud Image",1),e("button",{onClick:t[11]||(t[11]=(...o)=>s.closeModal&&s.closeModal(...o)),class:"btn-close"},"Ã—")]),e("form",{onSubmit:t[20]||(t[20]=D((...o)=>s.saveImage&&s.saveImage(...o),["prevent"])),class:"modal-body"},[e("div",Ge,[t[34]||(t[34]=e("label",{class:"form-label"},"Display Name *",-1)),f(e("input",{"onUpdate:modelValue":t[12]||(t[12]=o=>s.imageForm.name=o),class:"form-control",required:"",placeholder:"Ubuntu 24.04 LTS Cloud Image"},null,512),[[C,s.imageForm.name]])]),e("div",Ke,[t[35]||(t[35]=e("label",{class:"form-label"},"Filename *",-1)),f(e("input",{"onUpdate:modelValue":t[13]||(t[13]=o=>s.imageForm.filename=o),class:"form-control",required:"",placeholder:"ubuntu-24.04-server-cloudimg-amd64.img"},null,512),[[C,s.imageForm.filename]]),t[36]||(t[36]=e("p",{class:"text-xs text-muted mt-1"},"The filename of the cloud image file",-1))]),e("div",Je,[t[37]||(t[37]=e("label",{class:"form-label"},"Download URL *",-1)),f(e("input",{"onUpdate:modelValue":t[14]||(t[14]=o=>s.imageForm.download_url=o),class:"form-control",required:"",type:"url",placeholder:"https://cloud-images.ubuntu.com/..."},null,512),[[C,s.imageForm.download_url]]),t[38]||(t[38]=e("p",{class:"text-xs text-muted mt-1"},"Direct download URL for the cloud image",-1))]),e("div",Qe,[e("div",We,[t[40]||(t[40]=e("label",{class:"form-label"},"OS Type *",-1)),f(e("select",{"onUpdate:modelValue":t[15]||(t[15]=o=>s.imageForm.os_type=o),class:"form-control",required:""},[...t[39]||(t[39]=[$('<option value="" data-v-f41c8481>Select OS</option><option value="ubuntu" data-v-f41c8481>Ubuntu</option><option value="debian" data-v-f41c8481>Debian</option><option value="centos" data-v-f41c8481>CentOS</option><option value="rocky" data-v-f41c8481>Rocky Linux</option><option value="alma" data-v-f41c8481>AlmaLinux</option><option value="fedora" data-v-f41c8481>Fedora</option><option value="opensuse" data-v-f41c8481>openSUSE</option><option value="other" data-v-f41c8481>Other</option>',9)])],512),[[N,s.imageForm.os_type]])]),e("div",Xe,[t[41]||(t[41]=e("label",{class:"form-label"},"Version",-1)),f(e("input",{"onUpdate:modelValue":t[16]||(t[16]=o=>s.imageForm.version=o),class:"form-control",placeholder:"24.04"},null,512),[[C,s.imageForm.version]])])]),e("div",Ye,[e("div",Ze,[t[43]||(t[43]=e("label",{class:"form-label"},"Architecture",-1)),f(e("select",{"onUpdate:modelValue":t[17]||(t[17]=o=>s.imageForm.architecture=o),class:"form-control"},[...t[42]||(t[42]=[e("option",{value:"amd64"},"amd64 (x86_64)",-1),e("option",{value:"arm64"},"arm64",-1)])],512),[[N,s.imageForm.architecture]])]),e("div",$e,[t[44]||(t[44]=e("label",{class:"form-label"},"SHA256 Checksum",-1)),f(e("input",{"onUpdate:modelValue":t[18]||(t[18]=o=>s.imageForm.checksum=o),class:"form-control",placeholder:"Optional"},null,512),[[C,s.imageForm.checksum]])])]),e("div",et,[e("button",{type:"button",onClick:t[19]||(t[19]=(...o)=>s.closeModal&&s.closeModal(...o)),class:"btn btn-outline"},"Cancel"),e("button",{type:"submit",disabled:s.saving,class:"btn btn-primary"},r(s.saving?"Saving...":s.editingImage?"Update":"Add"),9,tt)])],32)])])):k("",!0)])}const lt=W(se,[["render",ot],["__scopeId","data-v-f41c8481"]]);export{lt as default};
